<!doctype html>
<html lang="th">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ¬∑ LINE ‚Üí Google Sheets</title>
    <style>
        :root {
            --bg: #0b1020;
            --panel: #121a2b;
            --muted: #7b89a6;
            --text: #e9eefc;
            --brand: #6aa6ff;
            --brand-2: #7ef0ff;
            --good: #2bd986;
            --bad: #ff6b6b;
            --table: #0f1629;
            --row: #0e1526;
            --row-alt: #0b1222;
            --chip: #1b2640;
            --shadow: 0 10px 25px rgba(0, 0, 0, .35);
            --radius: 18px;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
            background: radial-gradient(1200px 600px at 20% -10%, #122049 0%, transparent 55%),
                radial-gradient(900px 500px at 110% 10%, #103862 0%, transparent 60%), var(--bg);
            color: var(--text);
        }

        .wrap {
            max-width: 1100px;
            margin-inline: auto;
            padding: 28px 20px 60px
        }

        /* header */
        .hero {
            position: relative;
            overflow: hidden;
            border-radius: var(--radius);
            background: linear-gradient(135deg, #10203f 0%, #0c1830 60%, #0a1427 100%);
            padding: 24px;
            box-shadow: var(--shadow);
            border: 1px solid #1e2b48;
        }

        .hero h1 {
            margin: 0 0 6px;
            font-size: 26px;
            letter-spacing: .2px
        }

        .hero p {
            margin: 0;
            color: var(--muted)
        }

        .hero-badges {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 14px
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            padding: 8px 12px;
            border-radius: 999px;
            background: var(--chip);
            border: 1px solid #22345b;
            color: #cfe2ff;
        }

        .chip .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .dot.good {
            background: var(--good)
        }

        .dot.warn {
            background: #ffc857
        }

        .dot.bad {
            background: var(--bad)
        }

        /* toolbar */
        .toolbar {
            margin-top: 18px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between
        }

        .left,
        .right {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center
        }

        .search {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 12px;
            background: #0e1730;
            border: 1px solid #26345a;
            color: var(--text);
            min-width: 260px;
        }

        .search input {
            background: transparent;
            color: inherit;
            border: 0;
            outline: none;
            width: 220px;
            font-size: 14px;
        }

        .btn {
            appearance: none;
            border: 1px solid #2a3a66;
            background: #0f1a37;
            color: #cfe2ff;
            padding: 10px 14px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: .2s;
        }

        .btn:hover {
            transform: translateY(-1px);
            border-color: #365096
        }

        .btn.brand {
            background: linear-gradient(135deg, var(--brand) 0%, var(--brand-2) 100%);
            color: #00112a;
            border-color: transparent;
            box-shadow: 0 8px 22px rgba(122, 209, 255, .18);
        }

        .btn.ghost {
            background: #0e1730
        }

        .btn.red {
            background: #2a1120;
            border-color: #50304a;
            color: #ffd6de
        }

        .counter {
            color: #a8b7d6;
            font-size: 13px
        }

        /* table card */
        .card {
            margin-top: 14px;
            background: var(--panel);
            border: 1px solid #213153;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .table-wrap {
            overflow: auto
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 860px;
        }

        thead th {
            position: sticky;
            top: 0;
            background: linear-gradient(180deg, #17223f, #121b34);
            z-index: 1;
            font-weight: 700;
            font-size: 13px;
            letter-spacing: .25px;
            color: #cfe2ff;
            padding: 14px 14px;
            text-align: left;
            border-bottom: 1px solid #22345b;
        }

        tbody td {
            padding: 14px;
            border-bottom: 1px solid #172646;
            font-size: 14px;
            color: #dbe6ff;
            background: var(--row);
        }

        tbody tr:nth-child(even) td {
            background: var(--row-alt)
        }

        tbody tr:hover td {
            background: #132043
        }

        .id {
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
            font-size: 12.5px;
            color: #9eb2d8
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #1d2b4d;
            display: inline-grid;
            place-items: center;
            color: #9ec3ff;
            font-weight: 700;
            margin-right: 10px;
            overflow: hidden;
            border: 1px solid #2a3a66
        }

        .row-flex {
            display: flex;
            align-items: center
        }

        .email a {
            color: #a3d1ff;
            text-decoration: none
        }

        .email a:hover {
            text-decoration: underline
        }

        .pic a {
            color: #7ebcff;
            text-decoration: none
        }

        .empty {
            text-align: center;
            padding: 34px 16px;
            color: #a8b7d6
        }

        /* footer */
        .pager {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #0e1730;
            border-top: 1px solid #213153
        }

        .pager .group {
            display: flex;
            gap: 10px;
            align-items: center
        }

        .page-btn {
            padding: 9px 12px;
            border-radius: 10px;
            border: 1px solid #2a3a66;
            background: #0f1a37;
            color: #cfe2ff;
            cursor: pointer
        }

        .page-btn[disabled] {
            opacity: .4;
            cursor: not-allowed
        }

        /* small */
        @media (max-width:760px) {
            .hero {
                padding: 18px
            }

            .search {
                min-width: unset;
                width: 100%
            }

            .toolbar {
                gap: 12px
            }

            .right {
                width: 100%;
                justify-content: space-between
            }
        }

        /* subtle gradient border for hero */
        .hero::before {
            content: "";
            position: absolute;
            inset: -2px;
            border-radius: calc(var(--radius) + 2px);
            padding: 1px;
            background: linear-gradient(135deg, rgba(122, 209, 255, .45), rgba(110, 255, 233, .25));

            /* ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏Å‡πà‡∏≤/‡πÉ‡∏´‡∏°‡πà */
            -webkit-mask:
                linear-gradient(#000 0 0) content-box,
                linear-gradient(#000 0 0);
            -webkit-mask-composite: xor;

            mask:
                linear-gradient(#000 0 0) content-box,
                linear-gradient(#000 0 0);
            mask-composite: exclude;
        }
    </style>
</head>

<body>
    <div class="wrap">

        <section class="hero">
            <h1>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h1>
            <p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å Google Sheets ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</p>
            <div class="hero-badges">
                <span class="chip"><span class="dot good"></span>‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
                <span id="lastSync" class="chip"><span class="dot warn"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</span>
                <span id="sheetNameBadge" class="chip">‡∏ä‡∏µ‡∏ï: -</span>
            </div>

            <div class="toolbar">
                <div class="left">
                    <div class="search">
                        üîé
                        <input id="q" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ / ‡∏≠‡∏µ‡πÄ‡∏°‡∏• / userId‚Ä¶" />
                    </div>
                    <button class="btn ghost" id="refreshBtn">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
                    <button class="btn ghost" id="exportBtn">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV</button>
                </div>
                <div class="right">
                    <span class="counter" id="count">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                    <button class="btn red" id="closeBtn">‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>
        </section>

        <section class="card" aria-label="‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
            <div class="table-wrap">
                <table id="tbl">
                    <thead>
                        <tr>
                            <th style="width:54px">#</th>
                            <th data-sort="displayName">‡∏ä‡∏∑‡πà‡∏≠</th>
                            <th data-sort="email">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
                            <th data-sort="userId">userId</th>
                            <th>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</th>
                            <th data-sort="timestamp">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
                        </tr>
                    </thead>
                    <tbody id="tbody">
                        <tr>
                            <td colspan="6" class="empty">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="pager">
                <div class="group">
                    <button class="page-btn" id="prev">&larr; ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
                    <button class="page-btn" id="next">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ &rarr;</button>
                </div>
                <div class="group">
                    <span id="pageInfo" class="counter">‡∏´‡∏ô‡πâ‡∏≤ 1 / 1</span>
                    <select id="pageSize" class="page-btn" style="padding:8px 10px">
                        <option>10</option>
                        <option selected>20</option>
                        <option>50</option>
                        <option>100</option>
                    </select>
                </div>
            </div>
        </section>

    </div>

    <!-- (optional) LIFF SDK ‚Äì ‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î ‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏∞‡∏°‡∏µ fallback -->
    <script async src="https://static.line-scdn.net/liff/edge/2/sdk.js" onerror="/* ignore if blocked */"></script>
    <script>
        // ======= Config =======
        const API = '/api/users';          // endpoint ‡∏ù‡∏±‡πà‡∏á server.js
        const FALLBACK_CLOSE = () => window.history.length > 1 ? history.back() : window.close();

        // ======= State =======
        let rows = [];
        let filtered = [];
        let sortKey = 'timestamp';
        let sortAsc = false;
        let page = 1;
        let pageSize = 20;

        const $ = (sel, p = document) => p.querySelector(sel);
        const $$ = (sel, p = document) => [...p.querySelectorAll(sel)];
        const formatDate = iso => {
            if (!iso) return '-';
            const d = new Date(iso);
            return d.toLocaleString('th-TH', { dateStyle: 'medium', timeStyle: 'short' });
        };

        // ======= Render =======
        function render() {
            // sort
            filtered.sort((a, b) => {
                const A = (a[sortKey] || '').toString().toLowerCase();
                const B = (b[sortKey] || '').toString().toLowerCase();
                if (A === B) return 0;
                return (A > B ? 1 : -1) * (sortAsc ? 1 : -1);
            });

            // pagination
            const total = filtered.length;
            const pages = Math.max(1, Math.ceil(total / pageSize));
            page = Math.min(page, pages);
            const start = (page - 1) * pageSize;
            const items = filtered.slice(start, start + pageSize);

            $('#count').textContent = `${total.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
            $('#pageInfo').textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${page} / ${pages}`;
            $('#prev').disabled = page <= 1;
            $('#next').disabled = page >= pages;

            const tb = $('#tbody');
            if (!items.length) {
                tb.innerHTML = `<tr><td colspan="6" class="empty">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
                return;
            }

            tb.innerHTML = items.map((r, idx) => {
                const index = start + idx + 1;
                const initials = (r.displayName || '?').trim().split(/\s+/).map(s => s[0]).slice(0, 2).join('').toUpperCase();
                const avatar = r.pictureUrl
                    ? `<img src="${r.pictureUrl}" width="32" height="32" style="border-radius:50%;border:1px solid #2a3a66" loading="lazy" />`
                    : `<div class="avatar">${initials}</div>`;

                return `
          <tr>
            <td>${index}</td>
            <td>
              <div class="row-flex">
                ${r.pictureUrl ? avatar : `<div class="avatar">${initials}</div>`}
                <div>${escapeHtml(r.displayName || '-')}</div>
              </div>
            </td>
            <td class="email">${r.email ? `<a href="mailto:${r.email}">${escapeHtml(r.email)}</a>` : '-'}</td>
            <td class="id">${escapeHtml(r.userId || '-')}</td>
            <td class="pic">${r.pictureUrl ? `<a href="${r.pictureUrl}" target="_blank" rel="noopener">‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏π‡∏õ</a>` : '-'}</td>
            <td>${formatDate(r.timestamp)}</td>
          </tr>
        `;
            }).join('');
        }

        // ======= Data load =======
        async function load() {
            $('#tbody').innerHTML = `<tr><td colspan="6" class="empty">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</td></tr>`;
            try {
                const res = await fetch(API, { cache: 'no-store' });
                const data = await res.json();               // { header, items }
                rows = data.items || [];
                filtered = rows.slice();
                $('#sheetNameBadge').textContent = '‡∏ä‡∏µ‡∏ï: ' + (data.header?.[4] ? 'Users' : (new URLSearchParams(location.search).get('sheet') || 'Users'));
                $('#lastSync').innerHTML = `<span class="dot good"></span>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${formatDate(new Date().toISOString())}`;
                render();
            } catch (err) {
                console.error(err);
                $('#tbody').innerHTML = `<tr><td colspan="6" class="empty">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</td></tr>`;
                $('#lastSync').innerHTML = `<span class="dot bad"></span>‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`;
            }
        }

        // ======= Utils =======
        function debounce(fn, ms = 250) {
            let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
        }
        function escapeHtml(s) {
            return (s || '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
        }
        function exportCSV() {
            const cols = ['timestamp', 'userId', 'displayName', 'email', 'pictureUrl'];
            const head = ['timestamp', 'userId', 'displayName', 'email', 'pictureUrl'];
            const lines = [head.join(',')].concat(
                filtered.map(r => cols.map(k => {
                    const v = (r[k] ?? '').toString().replaceAll('"', '""');
                    return `"${v}"`;
                }).join(','))
            );
            const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `users_${new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-')}.csv`;
            document.body.appendChild(a); a.click(); a.remove();
        }

        // ======= Events =======
        $('#q').addEventListener('input', debounce(e => {
            const q = e.target.value.trim().toLowerCase();
            if (!q) { filtered = rows.slice(); page = 1; return render(); }
            filtered = rows.filter(r => {
                return [r.displayName, r.email, r.userId].some(x => (x || '').toLowerCase().includes(q));
            });
            page = 1; render();
        }, 180));

        $('#refreshBtn').addEventListener('click', () => load());
        $('#exportBtn').addEventListener('click', exportCSV);
        $('#prev').addEventListener('click', () => { page = Math.max(1, page - 1); render(); });
        $('#next').addEventListener('click', () => { page = page + 1; render(); });

        $('#pageSize').addEventListener('change', e => {
            pageSize = +e.target.value || 20; page = 1; render();
        });

        // sort by header click
        $$('th[data-sort]').forEach(th => {
            th.style.cursor = 'pointer';
            th.addEventListener('click', () => {
                const key = th.getAttribute('data-sort');
                if (sortKey === key) sortAsc = !sortAsc; else { sortKey = key; sortAsc = true; }
                render();
            });
        });

        // Close button (LIFF or fallback)
        $('#closeBtn').addEventListener('click', async () => {
            try {
                if (window.liff && typeof liff.closeWindow === 'function') {
                    // ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ LIFF_ID ‡∏Å‡πá‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô LIFF ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
                    liff.closeWindow();
                    return;
                }
            } catch (_) { }
            FALLBACK_CLOSE();
        });

        // init
        load();
    </script>
</body>

</html>